<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Places and Rate</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map { height: 600px; width: 100%; }
        #place-details { margin-top: 20px; }
        .place-item { cursor: pointer; padding: 5px; border: 1px solid #ddd; margin-bottom: 5px; }
        .place-item:hover { background-color: #f9f9f9; }
        select, input, button { margin: 10px 0; padding: 5px; }
        #search-results { border: 1px solid #ccc; max-height: 150px; overflow-y: auto; margin-top: 5px; }
        .search-result { padding: 5px; cursor: pointer; }
        .search-result:hover { background-color: #e0e0e0; }
        .search-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 10px 0;
        }
        #error-message { color: red; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>Search Places and Rate</h1>
    <button id="locate-btn">Locate Me</button>
    <div class="search-container">
        <label for="manual-location">Set Location Manually:</label>
        <input type="text" id="manual-location" placeholder="Enter location">
        <div id="search-results"></div>
    </div>
    <label for="tag">Search by Tag:</label>
    <select id="tag">
        <option value="restaurant">Restaurant</option>
        <option value="cafe">Cafe</option>
        <option value="bar">Bar</option>
        <option value="club">Club</option>
        <option value="shop">Shop</option>
    </select>
    <label for="ambiance">Select Ambiance:</label>
    <select id="ambiance">
        <option value="any">Any</option>
        <option value="chill">Chill</option>
        <option value="lively">Lively</option>
        <option value="romantic">Romantic</option>
        <option value="fun">Fun</option>
    </select>
    <label for="sort">Sort by:</label>
    <select id="sort">
        <option value="distance">Distance</option>
        <option value="reviews">Reviews</option>
    </select>
    <button id="search-btn">Search</button>
    <div id="error-message"></div>
    <div id="map"></div>
    <div id="place-details"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const map = L.map('map').setView([20.5937, 78.9629], 5);
        
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        
            let userMarker = null;
            const placeMarkers = [];
        
            const locateBtn = document.getElementById('locate-btn');
            const manualLocationInput = document.getElementById('manual-location');
            const searchResultsContainer = document.getElementById('search-results');
            const errorMessage = document.getElementById('error-message');
            const tagSelect = document.getElementById('tag');
            const ambianceSelect = document.getElementById('ambiance');
            const sortSelect = document.getElementById('sort');
            const searchBtn = document.getElementById('search-btn');
            const placeDetails = document.getElementById('place-details');
        
            const geocoderApiKey = '2f30476331e54e569f1f4a926097e208';
        
            function displayError(message) {
                errorMessage.textContent = message;
                setTimeout(() => (errorMessage.textContent = ''), 5000);
            }
        
            function locateUser() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;
                            map.setView([lat, lon], 15);
                            addUserMarker(lat, lon, "You are here");
                        },
                        () => {
                            displayError("Unable to access your location.");
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
        
                } else {
                    displayError("Geolocation not supported by this browser.");
                    fallbackGeoJS();
                }
            }
        
            function fallbackGeoJS() {
                fetch("https://get.geojs.io/v1/ip/geo.json")
                    .then(res => res.json())
                    .then(data => {
                        const lat = parseFloat(data.latitude);
                        const lon = parseFloat(data.longitude);
                        map.setView([lat, lon], 12);
                        addUserMarker(lat, lon, "Your approx. location (via IP)");
                    })
                    .catch(() => {
                        displayError("Unable to fetch location from GeoJS.");
                    });
            }
        
            <!-- Inside your <script> tag (just replace the existing addUserMarker function with this) -->
            function addUserMarker(lat, lon, popupText = "You are here") {
                if (userMarker) {
                    userMarker.setLatLng([lat, lon]).setPopupContent(popupText).openPopup();
                } else {
                    userMarker = L.marker([lat, lon], { draggable: true })
                        .addTo(map) 
                        .bindPopup(popupText)
                        .openPopup();
                
                    userMarker.on("dragend", function (e) {
                        const position = e.target.getLatLng();
                        map.setView([position.lat, position.lng], 15);
                        userMarker.setLatLng(position).setPopupContent("Location updated!").openPopup();
                    });
                }
            }
                
        
            manualLocationInput.addEventListener('input', () => {
                const query = manualLocationInput.value.trim();
                if (query.length < 3) return;
        
                fetch(`https://api.geocoderapi.com/v1/autocomplete?text=${encodeURIComponent(query)}&apikey=${geocoderApiKey}`)
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.results) {
                            displaySearchResults(data.results);
                        } else {
                            displayError("No results found.");
                        }
                    })
                    .catch(() => {
                        displayError("Error fetching location data.");
                    });
            });
        
            function displaySearchResults(results) {
                searchResultsContainer.innerHTML = '';
        
                if (results.length === 0) {
                    searchResultsContainer.innerHTML =
                        '<p>No results found. Try refining your search.</p>';
                    return;
                }
        
                results.forEach((result) => {
                    const searchResult = document.createElement('div');
                    searchResult.className = 'search-result';
                    searchResult.textContent = result.place_name;
                    searchResult.addEventListener('click', () => {
                        const [lon, lat] = result.center;
                        manualLocationInput.value = result.place_name;
                        map.setView([lat, lon], 15);
                        addUserMarker(lat, lon, result.place_name);
                        searchResultsContainer.innerHTML = '';
                    });
                    searchResultsContainer.appendChild(searchResult);
                });
            }
        
            // Clear all place markers
            function clearPlaceMarkers() {
                placeMarkers.forEach(marker => map.removeLayer(marker));
                placeMarkers.length = 0;
                placeDetails.innerHTML = '';
            }
        
            // Calculate distance between two lat/lon points in meters
            function distance(lat1, lon1, lat2, lon2) {
                const R = 6371000; // meters
                const toRad = x => x * Math.PI / 180;
                const dLat = toRad(lat2 - lat1);
                const dLon = toRad(lon2 - lon1);
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                          Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                          Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }
        
            // Fetch nearby places from Overpass API
            async function fetchNearbyPlaces(lat, lon, tag) {
                // Overpass QL query for amenities around lat/lon within 1 km
                const query = `
                    [out:json][timeout:25];
                    (
                      node["amenity"="${tag}"](around:1000,${lat},${lon});
                      way["amenity"="${tag}"](around:1000,${lat},${lon});
                      relation["amenity"="${tag}"](around:1000,${lat},${lon});
                    );
                    out center;
                `;
                const url = 'https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query);
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    return data.elements;
                } catch (error) {
                    displayError("Failed to fetch nearby places.");
                    return [];
                }
            }
        
            // Add place markers and list
            function displayPlaces(places, userLat, userLon) {
                clearPlaceMarkers();
        
                if (places.length === 0) {
                    placeDetails.innerHTML = '<p>No places found nearby.</p>';
                    return;
                }
        
                // Optional: Filter by ambiance here if you have data, currently skipped
        
                // Sort places
                if (sortSelect.value === 'distance') {
                    places.sort((a, b) => {
                        const aDist = distance(userLat, userLon, a.lat || a.center.lat, a.lon || a.center.lon);
                        const bDist = distance(userLat, userLon, b.lat || b.center.lat, b.lon || b.center.lon);
                        return aDist - bDist;
                    });
                } else if (sortSelect.value === 'reviews') {
                    // If you have ratings data, sort by average rating descending
                    // For now, no ratings data available, so fallback to distance
                    places.sort((a, b) => {
                        return 0; // No rating data, no sorting applied
                    });
                }
        
                places.forEach(place => {
                    const lat = place.lat || (place.center && place.center.lat);
                    const lon = place.lon || (place.center && place.center.lon);
                    const name = place.tags && place.tags.name ? place.tags.name : "Unnamed place";
                    const address = place.tags && place.tags['addr:full'] ? place.tags['addr:full'] : '';
                    const popupContent = `<b>${name}</b><br>${address}`;
        
                    const marker = L.marker([lat, lon]).addTo(map).bindPopup(popupContent);
                    placeMarkers.push(marker);
        
                    const div = document.createElement('div');
                    div.className = 'place-item';
                    div.textContent = name;
                    div.addEventListener('click', () => {
                        map.setView([lat, lon], 18);
                        marker.openPopup();
                    });
                    placeDetails.appendChild(div);
                });
            }
        
            // Search button event handler
            searchBtn.addEventListener('click', async () => {
                let lat, lon;
        
                if (manualLocationInput.value.trim()) {
                    // Use manual location input coordinates if possible
                    // But since manual input only sets map view and user marker on click,
                    // get userMarker's position as source of truth
                    if (userMarker) {
                        const pos = userMarker.getLatLng();
                        lat = pos.lat;
                        lon = pos.lng;
                    } else {
                        displayError("Please select a location from suggestions or use 'Locate Me' button.");
                        return;
                    }
                } else if (userMarker) {
                    const pos = userMarker.getLatLng();
                    lat = pos.lat;
                    lon = pos.lng;
                } else {
                    displayError("Please set your location manually or use 'Locate Me' button.");
                    return;
                }
        
                const selectedTag = tagSelect.value;
                // ambiance currently ignored - you can add filtering logic here
                // const selectedAmbiance = ambianceSelect.value;
        
                // Fetch nearby places and display them
                const places = await fetchNearbyPlaces(lat, lon, selectedTag);
                displayPlaces(places, lat, lon);
            });
        
            // Event Listeners
            locateBtn.addEventListener('click', locateUser);
        
            // Try GeoJS fallback on load if browser location is blocked
            setTimeout(() => {
                if (!userMarker) {
                    fallbackGeoJS();
                }
            }, 3000);
        });
        </script>
        
</body>
</html>